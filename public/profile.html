<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://kit.fontawesome.com/8831557fe7.js" crossorigin="anonymous"></script>
  <style>
    /* General layout for the page */
    .main-container {
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
    }
    /* Left column for posts (75% width) */
    .posts-container {
      padding: 20px;
    }
    .profile-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
      margin-right: auto;
      margin-left: auto;
    }
    .left-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 0 5rem;
      
    }
    /* Circular profile image */
    .profile-container img {
      width: 100px;
      height: 100px;
      border-radius: 50%; /* Makes the image circular */
      object-fit: cover; /* Ensures the image fits properly */
    }
    /* Edit Profile button */
    .profile-container button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .profile-container button:hover {
      background-color: #0056b3;
    }
    /* Individual post style */
    .post {
      background-color: #ffffff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
    }
    /* Username style */
    .post .username {
      font-weight: bold;
      margin-bottom: 5px;
    }
    /* Style for the reply button */
    .reply-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 10px;
    }
    .reply-button:hover {
      background-color: #0056b3;
    }
    /* Style for the replies container */
    .replies-container {
      margin-top: 10px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #ddd;
      display: none; /* Hidden by default */
    }
    /* Style for the reply form */
    .reply-form textarea {
      width: 95%;
      height: 60px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .reply-form button {
      padding: 5px 10px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    .reply-form button:hover {
      background-color: #218838;
    }
    /* Style for individual replies */
    .reply {
      margin-bottom: 10px;
      padding: 10px;
      background-color: #ffffff;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .reply .username {
      font-weight: bold;
      margin-bottom: 5px;
    }
    /* Title for posts */
    .posts-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    /* History container */
    .history {
      display: flex;
      flex-direction: column;
    }

    .history-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px; /* Space between title and items */
    }

    .history-container {
      display: flex; /* Use flexbox for horizontal layout */
      overflow-x: auto; /* Enable horizontal scrolling */
      padding: 10px 0; /* Add some vertical padding */
      gap: 10px; /* Space between items */
      background-color: white; /* White background */
      border-radius: 10px; /* Rounded edges */
      padding: 10px; /* Padding around the container */
      max-width: calc(100% - 20px); /* Adjust width to fit within the parent */
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);

    }

    .history-item {
      flex: 0 0 320px; /* Set a fixed width for each item */
      text-align: center;
      border: none;
      overflow: hidden; /* Ensure rounded edges */
      background-color: transparent;
    }

    .history-item img {
      width: 100%; /* Full width */
      border-radius: 10px; /* Rounded edges */
      height: 180px; /* Set a fixed height for uniformity */
      object-fit: cover; /* Ensures the image covers the area without distortion */
    }

    .history-item h3 {
      font-size: 16px;
      margin: 5px 0 0px 0; /* Space around title */
      border: none; /* Remove any border */
      padding: 5px; /* Padding for spacing */
      color: #000000;
      font-weight: 500; /* Same font weight as navbar */
      text-decoration: none; /* No underline */
      text-overflow: ellipsis; /* Adds "..." if text overflows */
    }

    .history-item a {
      text-decoration: none; /* No underline for links */
    }
    .history-container .history-item {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px;
    }
    
    .history-container .history-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .history-container .history-item img {
      margin-top: 10px;
    }
    .history-container .history-item img:hover {
      scale: 1.01;
      transition: 1s ease;
    }

    .enrolled-courses {
      display: flex;
      flex-direction: column;
    }

    .enrolled-courses .history-container {
      display: flex;
      overflow-x: auto;
      padding: 10px 0;
      gap: 10px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      max-width: calc(100% - 20px);
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .enrolled-courses .history-item {
      flex: 0 0 320px;
      text-align: center;
      border: none;
      overflow: hidden;
      background-color: transparent;
    }

    .enrolled-courses .history-item img {
      width: 100%;
      border-radius: 10px;
      height: 180px;
      object-fit: cover;
    }

    .enrolled-courses .history-item h3 {
      font-size: 16px;
      margin: 5px 0 0px 0;
      border: none;
      padding: 5px;
      color: #000000;
      font-weight: 500;
      text-decoration: none;
      text-overflow: ellipsis;
    }
    .enrolled-courses .history-item p {
      color: #666;
  font-size: 0.95rem;
  line-height: 1.5;
  margin-bottom: 1.5rem;
  display: -webkit-box;
  -webkit-line-clamp: 3; /* Limit to 3 lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
    }

    .enrolled-courses .history-item a {
      text-decoration: none;
    }

    .enrolled-courses .history-item button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .enrolled-courses .history-item button:hover {
      background-color: #0056b3;
    }
    #userCredits {
  font-size: 16px;
  color: #2c3e50;
  margin: 0;
}
  </style>
</head>
<body>
  <header class="headerr">
    <h3>gyaan_e</h3>
    <div class="mainSearch">
      <form id="searchForVid" action="search.html" method="GET">
        <input id="searchvid" name="q" placeholder="Search" type="text">
        <button type="submit">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
    </div>
    <nav>
      <ul class="nav_links">
        <li><a href="index.html">Feed</a></li>
        <li><a href="courses.html">Courses</a></li>
        <li><a href="community.html">Community</a></li>
        <button><a href="profile.html">Profile</a></button>
      </ul>
    </nav>
  </header>
  <main>
    <div class="main-container" id="mainContainer">
    <div class="left-container" id="leftContainer">
      <div class="profile-container" id="profileContainer">
        <img src="/images/profile.jpg" alt="">
        <h3 id="loggedInUsername"></h3>
        <p id="userCredits">Credits: <span id="creditsValue">0</span></p> 
        <button>Edit Profile</button>
        <button id="logout">Logout</button>
        
      </div>
      <div class="enrolled-courses">
        <h2>My Enrolled Courses</h2>
        <div class="history-container" id="enrolledCoursesContainer">
          <!-- Enrolled courses will be dynamically added here -->
        </div>
      </div>
      <div class="history">
          <div class="history-title">Watch History</div>
          <div class="history-container" id="historyContainer">
        
          </div>
      </div>
      <div>

      </div>
      
    </div>
    <!-- Posts Display -->
    <div class="posts-container" id="postsContainer">
      <div class="posts-title">Your Posts</div>
      <!-- Posts will be dynamically added here -->
    </div>
  </div>
  </main>

  <footer></footer>

  <script>
    // Function to get the logged-in username from the session
    async function getUsername() {
      try {
        const response = await fetch('/get-username', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('User not logged in');
        }
        const data = await response.json();
        return data.username; // Return the username
      } catch (error) {
        console.error('Error fetching username:', error);
        return 'user1'; // Fallback to 'user1' if the session is not available
      }
    }

    // Function to load and display posts for the logged-in user
    async function loadPosts() {
      try {
        // Fetch the logged-in user's username
        const username = await getUsername();

        // Update the username in the profile section
        const loggedInUsernameElement = document.getElementById('loggedInUsername');
        loggedInUsernameElement.textContent = `@${username}`;

        // Fetch and display user credits
        await loadUserCredits();

        // Fetch posts for the logged-in user
        const response = await fetch(`/posts?username=${username}`);
        if (!response.ok) {
          throw new Error('Failed to fetch posts');
        }

        const posts = await response.json();
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML = '<div class="posts-title">Your Posts</div>'; // Clear the container and add the title

        posts.reverse().forEach(post => {
          const postElement = document.createElement('div');
          postElement.classList.add('post');
          postElement.innerHTML = `
            <p class="username">@${post.username}</p>
            <p>${post.content}</p>
            <button class="reply-button">Replies</button>
            <div class="replies-container">
              <div class="replies-list"></div>
              <form class="reply-form">
                <textarea class="reply-content" placeholder="Write a reply..."></textarea>
                <button type="submit">Submit Reply</button>
              </form>
            </div>
          `;
          postsContainer.appendChild(postElement);

          // Add event listener for the reply button
          const replyButton = postElement.querySelector('.reply-button');
          const repliesContainer = postElement.querySelector('.replies-container');
          replyButton.addEventListener('click', () => {
            repliesContainer.style.display = repliesContainer.style.display === 'none' ? 'block' : 'none';
          });

          // Add event listener for the reply form
          const replyForm = postElement.querySelector('.reply-form');
          replyForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const replyContent = postElement.querySelector('.reply-content').value;
            const username = await getUsername();

            fetch('/create-reply', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ postId: post._id, username, content: replyContent })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Clear the reply input field
                postElement.querySelector('.reply-content').value = '';

                // Fetch and display the updated replies
                loadReplies(post._id, postElement.querySelector('.replies-list'));
              }
            })
            .catch(error => console.error('Error:', error));
          });

          // Load replies for this post
          loadReplies(post._id, postElement.querySelector('.replies-list'));
        });
      } catch (error) {
        console.error('Error loading posts:', error);
        alert('Failed to load posts.');
      }
    }

    // Function to load and display replies for a post
    function loadReplies(postId, repliesList) {
      fetch(`/replies?postId=${postId}`)
        .then(response => response.json())
        .then(replies => {
          repliesList.innerHTML = ''; // Clear the replies list before displaying new replies

          replies.forEach(reply => {
            const replyElement = document.createElement('div');
            replyElement.classList.add('reply');
            replyElement.innerHTML = `
              <p class="username">@${reply.username}</p>
              <p>${reply.content}</p>
            `;
            repliesList.appendChild(replyElement);
          });
        });
    }

    // Function to load and display watch history
    async function loadHistory() {
      try {
        const response = await fetch('/get-history', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Failed to fetch history');
        }
        const data = await response.json();

        if (data.success) {
          const historyContainer = document.getElementById('historyContainer');
          historyContainer.innerHTML = ''; // Clear the container and add the title

          // Reverse the history array to show the latest added first
      const reversedHistory = data.history.reverse();

reversedHistory.forEach(video => {
            const videoItem = document.createElement('div');
            videoItem.classList.add('history-item');
            videoItem.innerHTML = `
              <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank">
                <img src="${video.thumbnail}" alt="${video.title}">
                <div>
                  <h3>${video.title}</h3>
                </div>
              </a>
            `;
            historyContainer.appendChild(videoItem);
          });
        }
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    // Fetch and display enrolled courses
    async function loadEnrolledCourses() {
      const response = await fetch('/get-enrolled-courses', { credentials: 'include' });
      const data = await response.json();

      if (data.success) {
        const container = document.getElementById('enrolledCoursesContainer');
        container.innerHTML = ''; // Clear existing content

        data.courses.forEach((course) => {
          const courseElement = document.createElement('div');
          courseElement.className = 'history-item';
          courseElement.innerHTML = `
            <img src="${course.image}" alt="${course.title}">
            <h3>${course.title}</h3>
            <p>${course.description}</p>
            <button onclick="location.href='specific_course.html?courseId=${course._id}'">Open</button>
          `;
          container.appendChild(courseElement);
        });
      }
    }
    // Function to fetch and display user credits
    async function loadUserCredits() {
      try {
        const response = await fetch('/get-user-credits', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Failed to fetch user credits');
        }
        const data = await response.json();

        if (data.success) {
          document.getElementById('creditsValue').textContent = data.credits;
        }
      } catch (error) {
        console.error('Error loading user credits:', error);
      }
    }

    // Call this function on page load
    window.onload = function () {
      loadUserCredits();
      loadEnrolledCourses();
    };

    // Load posts and history when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadPosts();
      loadHistory();
    });

    // Logout functionality
    document.getElementById('logout').addEventListener('click', function(event) {
      fetch('/logout', {
        method: 'POST',
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = 'index.html'; // Redirect to login.html
        }
      })
    });
    
  </script>
</body>
</html>